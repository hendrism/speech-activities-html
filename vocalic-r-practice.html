<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocalic /r/ Word Practice</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #f8fafc;
            --accent: #3b82f6;
            --purple: #6366f1;
            --warning: #f59e0b;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .vocalic-r-practice {
            min-height: 100vh;
            background: var(--bg);
            display: flex;
            flex-direction: column;
        }

        .activity-header {
            background: white;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 6px rgba(15, 23, 42, 0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 18px 20px;
            display: grid;
            gap: 20px;
            grid-template-columns: minmax(0, 1.2fr) auto auto;
            align-items: center;
        }

        .header-content h1 {
            font-size: 24px;
            margin: 0 0 6px;
            color: var(--accent);
            font-weight: 800;
        }

        .header-subtitle {
            margin: 0;
            font-size: 14px;
            color: #475569;
            max-width: 460px;
        }

        .sound-summary {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.18), rgba(99, 102, 241, 0.18));
            color: #1e293b;
            padding: 10px 18px;
            border-radius: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .summary-count {
            font-size: 14px;
        }

        .summary-divider {
            opacity: 0.6;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        button {
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            border-radius: 10px;
            transition: all 0.2s ease;
        }

        .primary {
            background: var(--accent);
            color: white;
            padding: 10px 18px;
            border: 1px solid var(--accent);
        }

        .primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .primary:not(:disabled):hover {
            background: #2563eb;
        }

        .warning {
            background: var(--warning);
            color: white;
            padding: 10px 18px;
        }

        .warning:hover {
            background: #d97706;
        }

        .main-content {
            max-width: 1200px;
            margin: 24px auto;
            padding: 0 20px;
            width: 100%;
        }

        .activity-container {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 18px;
            padding: 28px;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
        }

        .instructions {
            background: #f0f9ff;
            border: 2px solid #38bdf8;
            border-radius: 14px;
            padding: 16px 20px;
            margin-bottom: 24px;
        }

        .instructions p {
            margin: 0;
            color: #0c4a6e;
            font-weight: 600;
        }

        .error-banner {
            background: #fef2f2;
            border: 2px solid #fca5a5;
            border-radius: 12px;
            padding: 14px 16px;
            margin-bottom: 20px;
            color: #b91c1c;
            font-weight: 600;
        }

        .selection-toolbar {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 20px;
            align-items: center;
        }

        .toolbar-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            background: #f8fafc;
            color: #1f2937;
            padding: 10px 16px;
            border: 1px solid #cbd5e1;
        }

        .toolbar-btn:hover {
            background: #e2e8f0;
        }

        .toolbar-options {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: center;
        }

        .option-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 14px;
            color: #475569;
            cursor: pointer;
        }

        .group-selection {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .group-card {
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 20px 22px;
            background: #f8fafc;
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 18px;
        }

        .group-info h3 {
            margin: 0 0 4px;
            font-size: 18px;
            color: #0f172a;
        }

        .group-info p {
            margin: 0;
            color: #475569;
            font-size: 14px;
        }

        .group-chip {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 4px 12px;
            border-radius: 999px;
            font-weight: 700;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .group-toggle {
            background: white;
            border: 1px solid #cbd5e1;
            color: #1f2937;
            padding: 8px 14px;
            border-radius: 8px;
            font-weight: 600;
        }

        .group-toggle:hover {
            background: #e2e8f0;
        }

        .set-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 12px;
        }

        .set-option {
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 12px 14px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .set-option:hover {
            border-color: var(--accent);
        }

        .set-option input {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .set-option.selected {
            background: #eff6ff;
            border-color: var(--accent);
            box-shadow: 0 6px 15px rgba(59, 130, 246, 0.18);
        }

        .set-title {
            font-weight: 700;
            color: #1f2937;
        }

        .set-detail {
            font-size: 13px;
            color: #475569;
        }

        .set-count {
            font-size: 12px;
            color: #64748b;
            font-weight: 600;
        }

        .start-footer {
            margin-top: 28px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 16px;
        }

        .selection-summary {
            font-size: 15px;
            color: #0f172a;
        }

        .start-btn {
            padding: 12px 24px;
            font-size: 15px;
            border-radius: 12px;
        }

        /* Practice mode styles */
        .practice-mode .practice-layout {
            display: grid;
            grid-template-columns: minmax(0, 320px) minmax(0, 1fr);
            gap: 24px;
            align-items: start;
        }

        .practice-sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: sticky;
            top: 100px;
        }

        .progress-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 18px;
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.1);
        }

        .progress-card h3 {
            margin: 0 0 12px;
            font-size: 16px;
            color: #0f172a;
        }

        .progress-bar {
            background: #e2e8f0;
            border-radius: 999px;
            height: 12px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            background: linear-gradient(135deg, var(--accent), var(--purple));
            height: 100%;
            border-radius: 999px;
            transition: width 0.3s ease;
        }

        .progress-card p {
            margin: 0;
            color: #475569;
            font-weight: 600;
        }

        .completion-badge {
            margin-top: 12px;
            background: #ecfdf5;
            color: #047857;
            padding: 10px 12px;
            border-radius: 10px;
            font-weight: 600;
            border: 1px solid #a7f3d0;
        }

        .word-checklist {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 18px;
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
            max-height: 520px;
            overflow-y: auto;
        }

        .word-checklist h3 {
            margin: 0 0 12px;
            font-size: 16px;
        }

        .checklist-group + .checklist-group {
            margin-top: 16px;
        }

        .checklist-header {
            border-left: 4px solid transparent;
            padding-left: 12px;
            margin-bottom: 10px;
        }

        .group-label {
            font-weight: 700;
            color: #0f172a;
        }

        .checklist-set + .checklist-set {
            margin-top: 10px;
        }

        .set-heading {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            color: #334155;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .set-subheading {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .word-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .word-pill {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .word-pill:hover {
            background: #e2e8f0;
        }

        .word-pill.practiced {
            background: #dcfce7;
            border-color: #22c55e;
            color: #166534;
        }

        .word-pill.active {
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }

        .sidebar-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .word-card-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .word-card {
            background: white;
            border: 3px solid transparent;
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.12);
        }

        .word-card.empty {
            border-color: #e2e8f0;
            text-align: center;
            font-weight: 600;
            color: #475569;
        }

        .word-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .word-chip {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 6px 12px;
            border-radius: 999px;
            font-weight: 700;
            font-size: 13px;
        }

        .word-count {
            font-size: 13px;
            color: #64748b;
            font-weight: 600;
        }

        .word-display {
            font-size: clamp(42px, 6vw, 60px);
            font-weight: 800;
            text-align: center;
            margin: 20px 0;
            color: #0f172a;
        }

        .word-details p {
            margin: 0;
            color: #334155;
            font-weight: 500;
        }

        .detail-note {
            font-size: 14px;
            color: #64748b;
            margin-top: 6px;
        }

        .card-actions {
            margin-top: 28px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
        }

        .nav-btn {
            background: #f1f5f9;
            color: #1f2937;
            padding: 12px 18px;
            border: 1px solid #cbd5e1;
        }

        .nav-btn:hover {
            background: #e2e8f0;
        }

        .nav-btn.primary {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .nav-btn.primary:hover {
            background: #2563eb;
        }

        .nav-btn.secondary {
            background: #f8fafc;
        }

        .nav-btn.secondary-active {
            background: #dcfce7;
            border-color: #22c55e;
            color: #166534;
        }

        .practice-hints {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 20px 24px;
        }

        .practice-hints h3 {
            margin: 0 0 12px;
            color: #0f172a;
        }

        .practice-hints ul {
            margin: 0;
            padding-left: 20px;
            color: #475569;
        }

        .practice-hints li + li {
            margin-top: 6px;
        }

        @media (max-width: 1024px) {
            .header-content {
                grid-template-columns: 1fr;
                text-align: center;
            }

            .sound-summary {
                justify-content: center;
            }

            .header-controls {
                justify-content: center;
                flex-wrap: wrap;
            }

            .practice-mode .practice-layout {
                grid-template-columns: 1fr;
            }

            .practice-sidebar {
                position: static;
            }

            .word-checklist {
                max-height: none;
            }
        }

        @media (max-width: 640px) {
            .set-grid {
                grid-template-columns: 1fr;
            }

            .card-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // Data
        const vocalicRGroups = [
            {
                id: 'ar',
                label: '/ar/',
                example: 'car',
                color: '#f97316',
                description: 'R-controlled vowel that sounds like the word "car"',
                sets: [
                    {
                        id: 'ar-initial',
                        label: 'Initial /ar/',
                        position: 'initial',
                        positionLabel: 'Initial',
                        description: 'Words beginning with the /ar/ sound',
                        words: ['Archie', 'artifact', 'artichoke']
                    },
                    {
                        id: 'ar-medial',
                        label: 'Medial /ar/',
                        position: 'medial',
                        positionLabel: 'Medial',
                        description: 'Words with /ar/ in the middle',
                        words: ['farm', 'barn', 'stardom']
                    },
                    {
                        id: 'ar-final',
                        label: 'Final /ar/',
                        position: 'final',
                        positionLabel: 'Final',
                        description: 'Words ending with /ar/',
                        words: ['star', 'bar', 'car']
                    }
                ]
            },
            {
                id: 'or',
                label: '/or/',
                example: 'corn',
                color: '#14b8a6',
                description: 'Rounded /or/ sound as in "corn"',
                sets: [
                    {
                        id: 'or-initial',
                        label: 'Initial /or/',
                        position: 'initial',
                        positionLabel: 'Initial',
                        description: 'Words beginning with the /or/ sound',
                        words: ['orca', 'ornament', 'Orville']
                    },
                    {
                        id: 'or-medial',
                        label: 'Medial /or/',
                        position: 'medial',
                        positionLabel: 'Medial',
                        description: 'Words with /or/ in the middle',
                        words: ['born', 'torn', 'short']
                    },
                    {
                        id: 'or-final',
                        label: 'Final /or/',
                        position: 'final',
                        positionLabel: 'Final',
                        description: 'Words ending with /or/',
                        words: ['bore', 'core', 'adore']
                    }
                ]
            },
            {
                id: 'er',
                label: '/er/',
                example: 'bird',
                color: '#6366f1',
                description: 'Retroflex or bunched /er/ sound',
                sets: [
                    {
                        id: 'er-initial',
                        label: 'Initial /er/',
                        position: 'initial',
                        positionLabel: 'Initial',
                        description: 'Words beginning with the /er/ sound',
                        words: ['Ernie', 'earth']
                    },
                    {
                        id: 'er-medial-stressed',
                        label: 'Medial /er/ (stressed)',
                        position: 'medial',
                        positionLabel: 'Medial (stressed)',
                        description: 'Stressed /er/ in the middle of a word',
                        words: ['bird', 'turn', 'firm']
                    },
                    {
                        id: 'er-medial-unstressed',
                        label: 'Medial /er/ (unstressed)',
                        position: 'medial',
                        positionLabel: 'Medial (unstressed)',
                        description: 'Unstressed vocalic /er/ syllables',
                        words: ['butterfly', 'buttercup', 'wonderful']
                    },
                    {
                        id: 'er-final',
                        label: 'Final /er/',
                        position: 'final',
                        positionLabel: 'Final',
                        description: 'Words ending with /er/',
                        words: ['father', 'mother', 'sister']
                    }
                ]
            },
            {
                id: 'ire',
                label: '/ire/',
                example: 'fire',
                color: '#facc15',
                description: '/ire/ diphthong with r-coloring',
                sets: [
                    {
                        id: 'ire-initial',
                        label: 'Initial /ire/',
                        position: 'initial',
                        positionLabel: 'Initial',
                        description: 'Words beginning with the /ire/ sound',
                        words: ['Ireland', 'iron', 'Irondale']
                    },
                    {
                        id: 'ire-medial',
                        label: 'Medial /ire/',
                        position: 'medial',
                        positionLabel: 'Medial',
                        description: 'Words with /ire/ in the middle',
                        words: ['fireman', 'firehose', 'firehouse']
                    },
                    {
                        id: 'ire-final',
                        label: 'Final /ire/',
                        position: 'final',
                        positionLabel: 'Final',
                        description: 'Words ending with /ire/',
                        words: ['tire', 'fire', 'wire']
                    }
                ]
            },
            {
                id: 'air',
                label: '/air/',
                example: 'chair',
                color: '#ec4899',
                description: 'R-controlled vowel pronounced like "chair"',
                sets: [
                    {
                        id: 'air-initial',
                        label: 'Initial /air/',
                        position: 'initial',
                        positionLabel: 'Initial',
                        description: 'Words beginning with the /air/ sound',
                        words: ['airplane', 'airbag', 'airport']
                    },
                    {
                        id: 'air-medial',
                        label: 'Medial /air/',
                        position: 'medial',
                        positionLabel: 'Medial',
                        description: 'Words with /air/ in the middle',
                        words: ['fairy', 'haircut', 'staircase']
                    },
                    {
                        id: 'air-final',
                        label: 'Final /air/',
                        position: 'final',
                        positionLabel: 'Final',
                        description: 'Words ending with /air/',
                        words: ['fair', 'hair', 'care']
                    }
                ]
            },
            {
                id: 'ear',
                label: '/ear/',
                example: 'ear',
                color: '#22d3ee',
                description: 'Fronted /ear/ sound as in "ear"',
                sets: [
                    {
                        id: 'ear-initial',
                        label: 'Initial /ear/',
                        position: 'initial',
                        positionLabel: 'Initial',
                        description: 'Words beginning with the /ear/ sound',
                        words: ['earwax', 'Erie', 'earache']
                    },
                    {
                        id: 'ear-medial',
                        label: 'Medial /ear/',
                        position: 'medial',
                        positionLabel: 'Medial',
                        description: 'Words with /ear/ in the middle',
                        words: ['beard', 'tiered', 'yearly']
                    },
                    {
                        id: 'ear-final',
                        label: 'Final /ear/',
                        position: 'final',
                        positionLabel: 'Final',
                        description: 'Words ending with /ear/',
                        words: ['deer', 'hear', 'near']
                    }
                ]
            }
        ];

        // Create lookup structures
        const allSetIds = vocalicRGroups.flatMap(group => group.sets.map(set => set.id));

        const setMetadata = vocalicRGroups.reduce((acc, group) => {
            group.sets.forEach(set => {
                acc[set.id] = {
                    ...set,
                    groupId: group.id,
                    groupLabel: group.label,
                    groupExample: group.example,
                    groupColor: group.color,
                    groupDescription: group.description
                };
            });
            return acc;
        }, {});

        const wordsBySet = vocalicRGroups.reduce((acc, group) => {
            group.sets.forEach(set => {
                acc[set.id] = set.words.map((word, index) => ({
                    id: `${set.id}-${index}`,
                    text: word,
                    setId: set.id,
                    setLabel: set.label,
                    position: set.position,
                    positionLabel: set.positionLabel,
                    description: set.description,
                    groupId: group.id,
                    groupLabel: group.label,
                    groupExample: group.example,
                    color: group.color
                }));
            });
            return acc;
        }, {});

        const allVocalicRWords = Object.values(wordsBySet).flat();

        // Helper functions
        function shuffleArray(items) {
            const array = [...items];
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // State
        let state = {
            selectedSets: ['ar-initial'],
            practiceQueue: [],
            currentIndex: 0,
            practicedWords: {},
            isPracticing: false,
            randomize: true,
            loopMode: false,
            error: ''
        };

        // Computed values
        function getSelectedWordPool() {
            return allVocalicRWords.filter(word => state.selectedSets.includes(word.setId));
        }

        function getCurrentWord() {
            return state.practiceQueue[state.currentIndex];
        }

        function getPracticedCount() {
            return state.practiceQueue.filter(word => state.practicedWords[word.id]).length;
        }

        function isSessionComplete() {
            return state.practiceQueue.length > 0 && getPracticedCount() === state.practiceQueue.length;
        }

        // Event handlers
        function toggleSetSelection(setId) {
            if (state.selectedSets.includes(setId)) {
                state.selectedSets = state.selectedSets.filter(id => id !== setId);
            } else {
                state.selectedSets = [...state.selectedSets, setId];
            }
            render();
        }

        function toggleGroupSelection(groupId) {
            const groupSetIds = vocalicRGroups.find(group => group.id === groupId)?.sets.map(set => set.id) || [];
            const hasAll = groupSetIds.every(setId => state.selectedSets.includes(setId));
            if (hasAll) {
                state.selectedSets = state.selectedSets.filter(setId => !groupSetIds.includes(setId));
            } else {
                state.selectedSets = Array.from(new Set([...state.selectedSets, ...groupSetIds]));
            }
            render();
        }

        function selectAllSets() {
            state.selectedSets = allSetIds;
            render();
        }

        function clearAllSets() {
            state.selectedSets = [];
            render();
        }

        function startPractice() {
            const selectedWordPool = getSelectedWordPool();
            if (selectedWordPool.length === 0) {
                state.error = 'Please select at least one word set to begin practicing.';
                render();
                return;
            }

            state.error = '';
            const queue = state.randomize ? shuffleArray(selectedWordPool) : [...selectedWordPool];
            state.practiceQueue = queue;
            state.currentIndex = 0;
            state.practicedWords = {};
            state.isPracticing = true;
            render();
        }

        function handleReturnToSetup() {
            state.isPracticing = false;
            state.practiceQueue = [];
            state.currentIndex = 0;
            state.practicedWords = {};
            render();
        }

        function handleNext() {
            if (state.practiceQueue.length === 0) return;
            if (state.currentIndex === state.practiceQueue.length - 1) {
                if (state.loopMode) {
                    state.currentIndex = 0;
                }
                render();
                return;
            }
            state.currentIndex++;
            render();
        }

        function handlePrevious() {
            if (state.practiceQueue.length === 0) return;
            if (state.currentIndex === 0) {
                if (state.loopMode) {
                    state.currentIndex = state.practiceQueue.length - 1;
                }
                render();
                return;
            }
            state.currentIndex--;
            render();
        }

        function handleMarkPracticed(wordId) {
            state.practicedWords[wordId] = !state.practicedWords[wordId];
            render();
        }

        function handleMarkAndAdvance() {
            const currentWord = getCurrentWord();
            if (!currentWord) return;

            state.practicedWords[currentWord.id] = true;

            if (state.practiceQueue.length === 0) return;
            if (state.currentIndex === state.practiceQueue.length - 1) {
                if (state.loopMode) {
                    state.currentIndex = 0;
                }
                render();
                return;
            }
            state.currentIndex++;
            render();
        }

        function handleJumpToWord(wordId) {
            const index = state.practiceQueue.findIndex(word => word.id === wordId);
            if (index !== -1) {
                state.currentIndex = index;
                render();
            }
        }

        function resetPracticeProgress() {
            state.practicedWords = {};
            state.currentIndex = 0;
            render();
        }

        function toggleRandomize() {
            state.randomize = !state.randomize;
            render();
        }

        function toggleLoopMode() {
            state.loopMode = !state.loopMode;
            render();
        }

        // Render functions
        function renderSetup() {
            const totalWordsSelected = getSelectedWordPool().length;

            return `
                <div class="vocalic-r-practice">
                    <header class="activity-header">
                        <div class="header-content">
                            <div>
                                <h1>üó£Ô∏è Vocalic /r/ Word Practice</h1>
                                <p class="header-subtitle">
                                    Customize your word lists and drill vocalic /r/ sounds at the word level.
                                </p>
                            </div>
                            <div class="sound-summary">
                                <span class="summary-count">${state.selectedSets.length} set${state.selectedSets.length === 1 ? '' : 's'} selected</span>
                                <span class="summary-divider">‚Ä¢</span>
                                <span class="summary-count">${totalWordsSelected} word${totalWordsSelected === 1 ? '' : 's'}</span>
                            </div>
                            <div class="header-controls">
                                <button class="primary" onclick="startPractice()" ${totalWordsSelected === 0 ? 'disabled' : ''}>
                                    ‚ñ∂Ô∏è Start Practice
                                </button>
                            </div>
                        </div>
                    </header>

                    <main class="main-content">
                        <div class="activity-container">
                            <section class="instructions">
                                <p>
                                    ‚úÖ Choose the vocalic /r/ positions you want to practice. You can mix and match sets,
                                    shuffle the order, and loop through your list as needed.
                                </p>
                            </section>

                            ${state.error ? `<div class="error-banner">${state.error}</div>` : ''}

                            <div class="selection-toolbar">
                                <div class="toolbar-buttons">
                                    <button class="toolbar-btn" onclick="selectAllSets()">
                                        Select All
                                    </button>
                                    <button class="toolbar-btn" onclick="clearAllSets()">
                                        Clear Selection
                                    </button>
                                </div>
                                <div class="toolbar-options">
                                    <label class="option-toggle">
                                        <input
                                            type="checkbox"
                                            ${state.randomize ? 'checked' : ''}
                                            onchange="toggleRandomize()"
                                        />
                                        <span>Shuffle words when starting</span>
                                    </label>
                                    <label class="option-toggle">
                                        <input
                                            type="checkbox"
                                            ${state.loopMode ? 'checked' : ''}
                                            onchange="toggleLoopMode()"
                                        />
                                        <span>Loop back to the beginning</span>
                                    </label>
                                </div>
                            </div>

                            <div class="group-selection">
                                ${vocalicRGroups.map(group => {
                                    const groupSetIds = group.sets.map(set => set.id);
                                    const allSelected = groupSetIds.every(setId => state.selectedSets.includes(setId));

                                    return `
                                        <div class="group-card">
                                            <div class="group-header">
                                                <div class="group-info">
                                                    <span class="group-chip" style="background-color: ${group.color}1a; color: ${group.color}">
                                                        ${group.label}
                                                    </span>
                                                    <h3>${group.label} ‚Äì "${group.example}"</h3>
                                                    <p>${group.description}</p>
                                                </div>
                                                <button
                                                    class="group-toggle"
                                                    onclick="toggleGroupSelection('${group.id}')"
                                                >
                                                    ${allSelected ? 'Remove Group' : 'Add Group'}
                                                </button>
                                            </div>
                                            <div class="set-grid">
                                                ${group.sets.map(set => {
                                                    const selected = state.selectedSets.includes(set.id);
                                                    return `
                                                        <label class="set-option ${selected ? 'selected' : ''}" onclick="toggleSetSelection('${set.id}')">
                                                            <input
                                                                type="checkbox"
                                                                ${selected ? 'checked' : ''}
                                                            />
                                                            <span class="set-title">${set.label}</span>
                                                            <span class="set-detail">${set.description}</span>
                                                            <span class="set-count">${set.words.length} word${set.words.length === 1 ? '' : 's'}</span>
                                                        </label>
                                                    `;
                                                }).join('')}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>

                            <div class="start-footer">
                                <div class="selection-summary">
                                    <strong>${totalWordsSelected}</strong> word${totalWordsSelected === 1 ? '' : 's'} ready to practice.
                                </div>
                                <button
                                    class="primary start-btn"
                                    onclick="startPractice()"
                                    ${totalWordsSelected === 0 ? 'disabled' : ''}
                                >
                                    ‚ñ∂Ô∏è Start Practice
                                </button>
                            </div>
                        </div>
                    </main>
                </div>
            `;
        }

        function renderPractice() {
            const currentWord = getCurrentWord();
            const practicedCount = getPracticedCount();
            const sessionComplete = isSessionComplete();
            const activeSetIds = new Set(state.practiceQueue.map(word => word.setId));

            return `
                <div class="vocalic-r-practice">
                    <header class="activity-header">
                        <div class="header-content">
                            <div>
                                <h1>üó£Ô∏è Vocalic /r/ Word Practice</h1>
                                <p class="header-subtitle">
                                    Customize your word lists and drill vocalic /r/ sounds at the word level.
                                </p>
                            </div>
                            <div class="sound-summary">
                                <span class="summary-count">${state.selectedSets.length} set${state.selectedSets.length === 1 ? '' : 's'} selected</span>
                                <span class="summary-divider">‚Ä¢</span>
                                <span class="summary-count">${state.practiceQueue.length} word${state.practiceQueue.length === 1 ? '' : 's'}</span>
                            </div>
                            <div class="header-controls">
                                <button class="warning" onclick="handleReturnToSetup()">
                                    üîÅ Back to Setup
                                </button>
                            </div>
                        </div>
                    </header>

                    <main class="main-content practice-mode">
                        <div class="practice-layout">
                            <aside class="practice-sidebar">
                                <div class="progress-card">
                                    <h3>Progress</h3>
                                    <div class="progress-bar">
                                        <div
                                            class="progress-fill"
                                            style="width: ${state.practiceQueue.length === 0 ? '0%' : Math.round((practicedCount / state.practiceQueue.length) * 100) + '%'}"
                                        ></div>
                                    </div>
                                    <p>
                                        ${practicedCount} / ${state.practiceQueue.length} words practiced
                                    </p>
                                    ${sessionComplete ? `
                                        <div class="completion-badge">
                                            üéâ Great work! All words practiced.
                                        </div>
                                    ` : ''}
                                </div>

                                <div class="word-checklist">
                                    <h3>Word List</h3>
                                    ${vocalicRGroups.map(group => {
                                        const groupSets = group.sets.filter(set => activeSetIds.has(set.id));
                                        if (groupSets.length === 0) return '';

                                        return `
                                            <div class="checklist-group">
                                                <div class="checklist-header" style="border-color: ${group.color}">
                                                    <span class="group-label">
                                                        ${group.label} ‚Ä¢ "${group.example}"
                                                    </span>
                                                </div>
                                                ${groupSets.map(set => `
                                                    <div class="checklist-set">
                                                        <div class="set-heading">
                                                            <span>${set.label}</span>
                                                            <span class="set-subheading">${set.positionLabel}</span>
                                                        </div>
                                                        <div class="word-pills">
                                                            ${wordsBySet[set.id].map(word => {
                                                                if (!activeSetIds.has(word.setId)) return '';

                                                                const practiced = state.practicedWords[word.id];
                                                                const isActive = currentWord?.id === word.id;

                                                                return `
                                                                    <button
                                                                        type="button"
                                                                        class="word-pill ${practiced ? 'practiced' : ''} ${isActive ? 'active' : ''}"
                                                                        onclick="handleJumpToWord('${word.id}')"
                                                                    >
                                                                        ${word.text}
                                                                    </button>
                                                                `;
                                                            }).join('')}
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>

                                <div class="sidebar-actions">
                                    <button class="toolbar-btn" onclick="resetPracticeProgress()">
                                        Reset Progress
                                    </button>
                                    <button class="toolbar-btn" onclick="handleReturnToSetup()">
                                        Change Word Sets
                                    </button>
                                </div>
                            </aside>

                            <section class="word-card-panel">
                                ${currentWord ? `
                                    <div class="word-card" style="border-color: ${currentWord.color}">
                                        <div class="word-card-header">
                                            <span class="word-chip" style="background-color: ${currentWord.color}1a; color: ${currentWord.color}">
                                                ${setMetadata[currentWord.setId].groupLabel} ‚Ä¢ ${setMetadata[currentWord.setId].positionLabel}
                                            </span>
                                            <span class="word-count">
                                                Word ${state.currentIndex + 1} of ${state.practiceQueue.length}
                                            </span>
                                        </div>
                                        <div class="word-display">
                                            ${currentWord.text}
                                        </div>
                                        <div class="word-details">
                                            <p>
                                                Practice the ${setMetadata[currentWord.setId].position.toUpperCase()} ${setMetadata[currentWord.setId].groupLabel} sound.
                                            </p>
                                            <p class="detail-note">${setMetadata[currentWord.setId].description}</p>
                                        </div>
                                        <div class="card-actions">
                                            <button onclick="handlePrevious()" class="nav-btn">
                                                ‚Üê Previous
                                            </button>
                                            <button onclick="handleMarkAndAdvance()" class="nav-btn primary">
                                                ‚úì Practice & Next
                                            </button>
                                            <button
                                                onclick="handleMarkPracticed('${currentWord.id}')"
                                                class="nav-btn ${state.practicedWords[currentWord.id] ? 'secondary-active' : 'secondary'}"
                                            >
                                                ${state.practicedWords[currentWord.id] ? 'Undo Practice' : 'Mark Practiced'}
                                            </button>
                                            <button onclick="handleNext()" class="nav-btn">
                                                Next ‚Üí
                                            </button>
                                        </div>
                                    </div>
                                ` : `
                                    <div class="word-card empty">
                                        <p>Select word sets and start practicing to see your word cards here.</p>
                                    </div>
                                `}

                                <div class="practice-hints">
                                    <h3>Tips for Practice</h3>
                                    <ul>
                                        <li>
                                            Say the word three times: slow, normal, and in a carrier phrase (e.g., "I can say ${currentWord ? currentWord.text : 'the word'}").
                                        </li>
                                        <li>Use the checklist to revisit any words that need extra practice.</li>
                                        <li>Toggle loop mode if you want to cycle through words continuously.</li>
                                    </ul>
                                </div>
                            </section>
                        </div>
                    </main>
                </div>
            `;
        }

        function render() {
            const app = document.getElementById('app');
            app.innerHTML = state.isPracticing ? renderPractice() : renderSetup();
        }

        // Initial render
        render();
    </script>
</body>
</html>
